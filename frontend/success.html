<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BroSplit AI ‚Äî Your Plan Is Ready</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0a0a0a;color:#fff;line-height:1.6;overflow-x:hidden;min-height:100vh}
    .bg-gradient{position:fixed;inset:0;background:
      radial-gradient(circle at 20% 80%, #ff6b6b 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, #4ecdc4 0%, transparent 50%),
      radial-gradient(circle at 40% 40%, #45b7d1 0%, transparent 50%);opacity:.1;z-index:-1}

    /* Sticky Email */
    .sticky-email-bar{position:fixed;top:0;left:0;right:0;background:rgba(255,107,107,.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,107,107,.3);box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:1000;transform:translateY(-100%);transition:transform .35s ease}
    .sticky-email-bar.show{transform:translateY(0)}
    .sticky-content{display:flex;align-items:center;justify-content:center;gap:1rem;padding:1rem;max-width:1000px;margin:0 auto;position:relative}
    .sticky-text{color:#fff;font-weight:600}
    .btn-sticky{background:rgba(255,255,255,.15);color:#fff;border:2px solid rgba(255,255,255,.25);padding:.6rem 1.2rem;border-radius:12px;font-weight:700;cursor:pointer;transition:.2s}
    .btn-sticky:hover{transform:translateY(-1px)}
    .btn-dismiss{position:absolute;right:1rem;background:transparent;border:none;color:#fff8;padding:.25rem .5rem;font-size:1.5rem;cursor:pointer}

    .container{max-width:1000px;margin:0 auto;padding:2rem;position:relative;z-index:1}
    .container.with-sticky{padding-top:5.5rem}
    .header{text-align:center;margin-bottom:2rem}
    .header h1{font-size:3rem;font-weight:900;margin-bottom:.25rem;background:linear-gradient(135deg,#ff6b6b,#4ecdc4,#45b7d1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .subtitle{color:#e0e0e0}

    .card{background:rgba(255,255,255,.05);backdrop-filter:blur(16px);border-radius:20px;padding:2rem;border:1px solid rgba(255,255,255,.1);box-shadow:0 25px 50px -12px rgba(0,0,0,.5);margin-bottom:1.2rem}
    .success-title{font-size:2rem;font-weight:800;color:#4ecdc4;margin-bottom:.6rem;text-align:center}

    .btn{padding:1rem 2rem;border:none;border-radius:14px;font-weight:800;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:.5rem;text-decoration:none}
    .btn-primary{background:linear-gradient(135deg,#ff6b6b,#ff5252);color:#fff}
    .btn-secondary{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.18)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .plan-header{text-align:center;margin:0 0 1.2rem}
    #plan{background:#fff;color:#1f2937;border-radius:14px;padding:1.6rem;white-space:pre-wrap}

    /* Nutrition */
    .nutrition-card{background:linear-gradient(180deg,rgba(20,83,45,.35),rgba(15,23,42,.2));border:1px solid rgba(16,185,129,.25);border-radius:18px;padding:1.4rem;margin:1.2rem 0}
    .n-title{display:flex;align-items:center;gap:.6rem;font-weight:900;font-size:1.4rem;margin-bottom:.6rem}
    .chip-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.6rem;margin:.6rem 0}
    .chip{background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);padding:.7rem 1rem;border-radius:12px}
    .soft{font-family:ui-monospace,Menlo,Consolas,monospace;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:1rem;white-space:pre-wrap}

    .day{margin:1rem 0;padding:1rem;border:1px dashed rgba(255,255,255,.15);border-radius:12px}
    .meal{margin:.5rem 0 .2rem;font-weight:700}
    .ingredients{margin-left:1rem;opacity:.9}
    .g-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.6rem}
    .g-item{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:.8rem 1rem;border-radius:12px}

    .guarantee{background:rgba(76,175,80,.1);border:1px solid rgba(76,175,80,.3);padding:1rem;border-radius:12px;text-align:center;margin-top:1rem}

    @media (max-width:768px){
      .container{padding:1rem}
      .header h1{font-size:2.2rem}
      #plan{padding:1.1rem}
    }
  </style>
</head>
<body>
  <div class="bg-gradient"></div>

  <!-- Sticky Email Bar -->
  <div id="stickyEmailBar" class="sticky-email-bar" style="display:none;">
    <div class="sticky-content">
      <span class="sticky-text">üìß Don‚Äôt lose your plan! Get your PDFs emailed to you.</span>
      <button id="stickyEmailBtn" class="btn-sticky">Email My PDFs</button>
      <button id="dismissSticky" class="btn-dismiss">√ó</button>
    </div>
  </div>

  <div class="container" id="mainContainer">
    <div class="header">
      <h1>BroSplit AI</h1>
      <p class="subtitle" id="subtitle">Your personalized workout plan is ready</p>
    </div>

    <div class="card">
      <h2 class="success-title">üéâ Payment Complete!</h2>
      <p class="subtitle" id="successDesc" style="text-align:center;margin-bottom:1rem;">
        You're ready to generate your personalized plan!
      </p>
      <div style="display:flex;gap:.8rem;justify-content:center;flex-wrap:wrap">
        <button id="generatePlan" class="btn btn-primary">üöÄ Generate My Plan</button>
        <a href="index.html" class="btn btn-secondary">‚Üê Back to Start</a>
      </div>
    </div>

    <div id="planLoading"></div>
    <div id="planError"></div>

    <div id="planContainer" class="card" style="display:none;">
      <div class="plan-header">
        <h2 style="font-size:1.6rem;font-weight:900;">üèãÔ∏è‚Äç‚ôÇÔ∏è Your Custom Workout Plan</h2>
        <p class="subtitle">Tailored specifically for your goals and preferences</p>
      </div>
      <div id="plan"></div>

      <!-- Nutrition -->
      <div id="nutritionContainer" class="nutrition-card" style="display:none;">
        <div class="n-title">ü•ó Nutrition Plan <span style="opacity:.85;font-weight:600;">(Macros + Meals)</span></div>
        <div id="nutritionSummary" class="chip-grid"></div>
        <div id="nutritionGuidelines" class="soft" style="margin:.6rem 0;"></div>
        <div id="nutritionDays"></div>

        <h3 class="n-title" style="margin-top:.8rem;">üõí Grocery List</h3>
        <div id="groceryList" class="g-grid"></div>

        <h3 class="n-title" style="margin-top:.8rem;">üç± Batch Prep</h3>
        <div id="batchPrep" class="soft"></div>

        <div style="display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.8rem;">
          <button id="downloadNutritionPdf" class="btn btn-secondary">‚¨áÔ∏è Download Nutrition PDF</button>
          <button id="downloadNutritionJson" class="btn btn-secondary">‚¨áÔ∏è Download Nutrition JSON</button>
          <button id="copyGrocery" class="btn btn-secondary">üìã Copy Grocery List</button>
        </div>
      </div>

      <div class="guarantee">
        <p><strong>üíØ No-BS Guarantee</strong><br>If you don't see noticeable gains in the first 30 days, we'll refund every penny.</p>
      </div>
    </div>

    <div style="text-align:center;">
      <button id="emailPlan" class="btn btn-primary" style="display:none;margin:1rem auto;">üìß Email Me My PDFs</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const API_URL = window.location.origin;
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('session_id');
    if (!sessionId) {
      document.body.innerHTML = `
        <div class="bg-gradient"></div>
        <div class="container">
          <div class="card">
            <h2 style="color:#ff6b6b">‚ö†Ô∏è Error: No session ID found</h2>
            <p class="subtitle">Please return to the homepage and try again.</p>
            <a href="index.html" class="btn btn-primary">‚Üê Back to Start</a>
          </div>
        </div>`;
      throw new Error("No session_id in URL");
    }

    let formData = {};
    let planType = 'workout';
    try {
      formData = JSON.parse(localStorage.getItem('brosplitForm') || '{}');
      planType = localStorage.getItem('planType') || 'workout';
    } catch {}

    if (planType === 'pro') {
      document.getElementById('subtitle').textContent = 'Your personalized training + nutrition plan is ready';
      document.getElementById('successDesc').textContent = 'Time to generate your workout and nutrition plan.';
    }

    const generateBtn = document.getElementById('generatePlan');
    const emailBtn = document.getElementById('emailPlan');
    const stickyEmailBtn = document.getElementById('stickyEmailBtn');
    const dismissStickyBtn = document.getElementById('dismissSticky');
    const stickyEmailBar = document.getElementById('stickyEmailBar');
    const mainContainer = document.getElementById('mainContainer');

    const planDiv = document.getElementById('plan');
    const planCard = document.getElementById('planContainer');
    const planError = document.getElementById('planError');
    const planLoading = document.getElementById('planLoading');

    const nutritionContainer = document.getElementById('nutritionContainer');
    const nutritionSummary = document.getElementById('nutritionSummary');
    const nutritionGuidelines = document.getElementById('nutritionGuidelines');
    const nutritionDays = document.getElementById('nutritionDays');
    const groceryList = document.getElementById('groceryList');
    const batchPrep = document.getElementById('batchPrep');
    const downloadNutritionPdf = document.getElementById('downloadNutritionPdf');
    const downloadNutritionJson = document.getElementById('downloadNutritionJson');
    const copyGrocery = document.getElementById('copyGrocery');

    let stickyBarDismissed = false;
    let nutritionPlan = null;

    function showStickyBar() {
      if (!stickyBarDismissed) {
        stickyEmailBar.style.display = 'block';
        stickyEmailBar.classList.add('show');
        mainContainer.classList.add('with-sticky');
      }
    }
    function hideStickyBar() {
      stickyEmailBar.classList.remove('show');
      mainContainer.classList.remove('with-sticky');
      setTimeout(()=>{ if(!stickyEmailBar.classList.contains('show')) stickyEmailBar.style.display='none'; }, 320);
    }
    dismissStickyBtn.addEventListener('click', ()=>{ stickyBarDismissed = true; hideStickyBar(); });

    function maybeMacrosText(m) {
      if (!m) return '';
      const vals = [m.kcal, m.protein_g, m.carbs_g, m.fat_g];
      const valid = vals.some(v => typeof v === 'number' && v > 0);
      return valid ? ` (${m.kcal||0} kcal ‚Ä¢ P${m.protein_g||0}/C${m.carbs_g||0}/F${m.fat_g||0})` : '';
    }

    function renderNutrition(n) {
      if (!n) return;

      // Summary chips
      const s = n.summary || {};
      const chips = [
        ["Calories", `${s.calories} kcal`],
        ["Protein", `${s.protein_g} g/day (~${s.per_meal_protein_g} g/meal)`],
        ["Carbs", `${s.carbs_g} g/day`],
        ["Fat", `${s.fat_g} g/day`],
        ["Fiber", `${s.fiber_target_g} g/day`],
        ["Sodium cap", `${s.sodium_cap_mg} mg/day`],
        ["Meals/day", `${s.meals_per_day}`],
      ];
      nutritionSummary.innerHTML = chips.map(([k,v]) => `<div class="chip"><strong>${k}</strong><br>${v}</div>`).join('');

      // Guidelines
      const g = n.guidelines || {};
      nutritionGuidelines.textContent =
        `‚Ä¢ Protein per meal: ${g.protein_per_meal_rule || '‚Äî'}\n` +
        `‚Ä¢ Pre/Post training: ${g.pre_post || '‚Äî'}\n` +
        `‚Ä¢ Notes: ${g.notes || '‚Äî'}`;

      // Days (first 7)
      nutritionDays.innerHTML = (n.day_plans||[]).slice(0,7).map(d=>{
        const meals = (d.meals||[]).map(m=>{
          const ing = (m.ingredients||[]).map(i=>{
            if (i.grams) return `‚Ä¢ ${i.item} ‚Äî ${i.grams} g`;
            if (i.kg)    return `‚Ä¢ ${i.item} ‚Äî ${i.kg} kg`;
            if (i.ml)    return `‚Ä¢ ${i.item} ‚Äî ${i.ml} ml`;
            if (i.count) return `‚Ä¢ ${i.item} ‚Äî ${i.count} ct`;
            return `‚Ä¢ ${i.item}`;
          }).join('\n');
          return `
            <div class="meal">${m.name || 'Meal'}${maybeMacrosText(m.macros)}</div>
            <div>${m.recipe || ''}</div>
            ${ing ? `<div class="ingredients soft" style="margin:.4rem 0 0">${ing}</div>` : ''}
          `;
        }).join('');
        return `<div class="day"><div style="font-weight:800;margin-bottom:.3rem;">Day ${d.day} ‚Äî ${d.total_kcal || s.calories} kcal</div>${meals}</div>`;
      }).join('');

      // Grocery
      groceryList.innerHTML = (n.grocery_list?.items||[]).map(it=>{
        const qty = it.kg ? `${it.kg} kg` : it.ml ? `${it.ml} ml` : it.count ? `${it.count} ct` : it.grams ? `${it.grams} g` : '';
        return `<div class="g-item">${it.item}${qty ? ` ‚Äî ${qty}` : ''}</div>`;
      }).join('');

      // Batch prep
      batchPrep.textContent = (n.batch_prep||[]).map(b => `‚Ä¢ ${b.day}: ${Array.isArray(b.steps)? b.steps.join(' ‚Ä¢ ') : ''}`).join('\n');

      nutritionContainer.style.display = 'block';
    }

    function blobDownload(filename, content, type='application/octet-stream') {
      const blob = new Blob([content], {type}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    downloadNutritionJson.addEventListener('click', () => {
      if (!nutritionPlan) return alert('Nutrition plan not generated yet.');
      blobDownload('BroSplit-Nutrition-Plan.json', JSON.stringify(nutritionPlan, null, 2), 'application/json');
    });

    downloadNutritionPdf.addEventListener('click', async () => {
      if (!nutritionPlan) return alert('Nutrition plan not generated yet.');
      const btn = downloadNutritionPdf; const txt = btn.textContent; btn.disabled = true; btn.textContent = '‚è≥ Building PDF‚Ä¶';
      try {
        const resp = await fetch(`${API_URL}/api/nutrition-pdf`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ plan: nutritionPlan, userProfile: { name: formData.name || '' } })
        });
        if (!resp.ok) throw new Error('Failed to build PDF');
        const blob = await resp.blob();
        blobDownload('BroSplit-Nutrition-Plan.pdf', blob, 'application/pdf');
      } catch (e) {
        alert('PDF failed: ' + e.message);
      } finally { btn.disabled=false; btn.textContent = txt; }
    });

    async function sendEmail(button) {
      const originalText = button.innerHTML;
      button.disabled = true; button.innerHTML = '‚è≥ Sending‚Ä¶';
      const email = (formData.email || '').trim();
      const planText = (document.getElementById('plan').innerText || '').trim();
      if (!email) { alert("‚ö†Ô∏è No email address found."); button.innerHTML = originalText; button.disabled = false; return; }
      if (!planText) { alert("‚ö†Ô∏è Generate your plan first."); button.innerHTML = originalText; button.disabled = false; return; }

      try {
        const resp = await fetch(`${API_URL}/api/email-plan`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, plan: planText, nutrition: nutritionPlan, userProfile: { name: formData.name || '' } })
        });
        if (!resp.ok) throw new Error("Server rejected the email");
        button.innerHTML = '‚úÖ Sent!';
        localStorage.removeItem('brosplitForm'); localStorage.removeItem('planType');
        if (button === stickyEmailBtn) { stickyBarDismissed = true; hideStickyBar(); }
        setTimeout(() => { button.innerHTML = originalText; }, 2000);
      } catch (err) {
        console.error(err); button.innerHTML = '‚ùå Failed'; alert("‚ö†Ô∏è " + (err.message || 'Email failed'));
        setTimeout(() => { button.innerHTML = originalText; }, 2000);
      } finally { button.disabled = false; }
    }

    emailBtn.addEventListener('click', () => sendEmail(emailBtn));
    stickyEmailBtn.addEventListener('click', () => sendEmail(stickyEmailBtn));

    // Generate flow
    document.getElementById('generatePlan').addEventListener('click', async () => {
      planDiv.innerHTML=""; planError.innerHTML=""; planCard.style.display="none";
      emailBtn.style.display="none"; nutritionContainer.style.display="none";
      nutritionPlan=null; stickyBarDismissed=false; hideStickyBar();
      generateBtn.disabled=true;

      planLoading.innerHTML = `
        <div class="card">
          <div style="font-size:3rem;text-align:center">ü§ñüí≠üèãÔ∏è</div>
          <h3 style="text-align:center;margin:.6rem 0;">Generating your workout plan‚Ä¶</h3>
          <p class="subtitle" style="text-align:center">Analyzing your inputs and building the perfect split.</p>
        </div>`;

      try {
        // 1) Workout
        const res = await fetch(`${API_URL}/api/generate-plan`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, ...formData })
        });
        if (!res.ok) throw new Error("Could not generate workout plan.");
        const { plan } = await res.json();

        planDiv.innerHTML = marked.parse(plan);
        planCard.style.display = "block";
        emailBtn.style.display = "inline-flex";
        planCard.scrollIntoView({ behavior: 'smooth' });

        // 2) Nutrition (Pro)
        if (planType === 'pro') {
          planLoading.innerHTML = `
            <div class="card" style="border-color:rgba(16,185,129,.35)">
              <h3 style="text-align:center;color:#86efac">ü•ó Generating your nutrition plan‚Ä¶</h3>
              <p class="subtitle" style="text-align:center">Macros, meals, grocery list, and batch prep.</p>
            </div>`;
          const payload = {
            sex: formData.sex,
            age: Number(formData.age),
            height_cm: formData.height_cm,
            weight_kg: formData.weight_kg,
            activity: formData.activity || 'moderate',
            goal: formData.nutrition_goal || 'recomp',
            training_load: formData.training_load || 'moderate',
            meals_per_day: formData.meals_per_day || 4,
            cuisine_prefs: formData.cuisine_prefs || [],
            diet_prefs: formData.diet_prefs || ['none'],
            allergies: formData.allergies || [],
            budget_level: formData.budget_level || 'normal',
            email: formData.email
          };
          const nres = await fetch(`${API_URL}/api/nutrition`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
          });
          if (!nres.ok) throw new Error("Could not generate nutrition plan.");
          const ndata = await nres.json();
          nutritionPlan = ndata.plan;
          renderNutrition(nutritionPlan);
        }

        planLoading.innerHTML = '';
        setTimeout(()=>{ if (planCard.style.display === "block") showStickyBar(); }, 1500);

      } catch (err) {
        planLoading.innerHTML = '';
        planError.innerHTML = `
          <div class="card" style="border-color:rgba(255,107,107,.35)">
            <h3 style="color:#ff6b6b">‚ö†Ô∏è Generation Failed</h3>
            <p class="subtitle">${err.message || "Could not generate plan."}</p>
            <button onclick="location.reload()" class="btn btn-primary" style="margin-top:.6rem">üîÑ Try Again</button>
          </div>`;
      } finally {
        generateBtn.disabled=false;
      }
    });

    // Clean up any animation classes (smoother load)
    setTimeout(()=>{ document.querySelectorAll('.celebrate').forEach(el=>el.classList.remove('celebrate')); }, 600);
  </script>
</body>
</html>
