<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BroSplit AI ‚Äî Your Plan Is Ready</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0a0a0a;color:#fff;line-height:1.6;overflow-x:hidden;min-height:100vh}
    .bg-gradient{position:fixed;inset:0;background:
      radial-gradient(circle at 20% 80%, #ff6b6b 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, #4ecdc4 0%, transparent 50%),
      radial-gradient(circle at 40% 40%, #45b7d1 0%, transparent 50%);opacity:.1;z-index:-1}

    .container{max-width:1000px;margin:0 auto;padding:2rem;position:relative;z-index:1}
    .header{text-align:center;margin-bottom:2rem;animation:slideDown .6s ease-out}
    .header h1{font-size:3rem;font-weight:900;margin-bottom:.5rem;background:linear-gradient(135deg,#ff6b6b,#4ecdc4,#45b7d1);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-.02em;line-height:1.1}
    .subtitle{font-size:1.1rem;color:#e0e0e0}

    /* Sticky email bar */
    .sticky-email-bar{display:none;position:fixed;top:0;left:0;right:0;background:rgba(255,107,107,.95);backdrop-filter:blur(20px);
      border-bottom:1px solid rgba(255,107,107,.3);box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:1000;transform:translateY(-100%);transition:transform .35s ease}
    .sticky-email-bar.show{display:block;animation:slideDownSticky .45s ease-out forwards}
    .sticky-content{display:flex;align-items:center;justify-content:center;gap:1rem;padding:1rem;max-width:1000px;margin:0 auto;position:relative}
    .sticky-text{color:#fff;font-weight:600;font-size:1rem}
    .btn-sticky{background:rgba(255,255,255,.2);color:#fff;border:2px solid rgba(255,255,255,.3);padding:.6rem 1.5rem;border-radius:12px;
      font-weight:700;cursor:pointer;transition:all .2s ease;font-size:.95rem;text-transform:uppercase;letter-spacing:.5px}
    .btn-sticky:hover{background:rgba(255,255,255,.3);transform:translateY(-1px)}
    .btn-dismiss{background:transparent;color:rgba(255,255,255,.7);border:none;font-size:1.4rem;cursor:pointer;padding:.25rem .5rem;border-radius:6px;position:absolute;right:1rem}

    /* Cards + buttons */
    .card{background:rgba(255,255,255,.05);backdrop-filter:blur(20px);border-radius:24px;padding:2rem;border:1px solid rgba(255,255,255,.1);
      box-shadow:0 25px 50px -12px rgba(0,0,0,.5);margin-bottom:1.25rem}
    .success-card{display:flex;flex-direction:column;align-items:center;text-align:center;overflow:hidden}
    .success-title{font-size:2rem;font-weight:800;color:#4ecdc4;margin:.25rem 0 1rem}
    .button-group{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center}
    .btn{padding:1rem 2rem;border:none;border-radius:16px;font-size:1.05rem;font-weight:800;cursor:pointer;transition:all .2s ease;text-decoration:none;display:inline-flex;align-items:center;gap:.5rem;letter-spacing:.5px}
    .btn-primary{background:linear-gradient(135deg,#ff6b6b,#ff5252);color:#fff}
    .btn-secondary{background:rgba(255,255,255,.1);color:#e0e0e0;border:1px solid rgba(255,255,255,.2)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Section headers */
    .section-title{font-size:1.6rem;font-weight:900;margin-bottom:.75rem}
    .muted{color:#cbd5e1}

    /* Workout/Nutrition bodies themed identically */
    .white-card{background:#fff;color:#1f2937;border-radius:16px;padding:1.5rem;border:1px solid #e5e7eb}
    #plan h1{font-size:1.6rem;font-weight:900;margin:0 0 1rem 0;border-bottom:3px solid #ff6b6b;padding-bottom:.75rem}
    #plan h2{font-size:1.25rem;font-weight:800;margin:1.25rem 0 .75rem}
    #plan h3{font-size:1.05rem;font-weight:700;margin:1rem 0 .5rem}
    #plan ul{margin-left:1rem}

    /* Nutrition UI */
    .nutrition-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin:1rem 0}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:1rem;border-radius:12px}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.95rem;white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.1);padding:1rem;border-radius:12px}
    .divider{height:2px;background:linear-gradient(90deg,transparent,#4ecdc4,transparent);border:0;margin:1.25rem 0}

    /* Loading */
    .loading-card{text-align:center}
    .progress{height:8px;background:rgba(255,255,255,.15);border-radius:6px;overflow:hidden;margin-top:1rem}
    .bar{height:100%;background:linear-gradient(135deg,#ff6b6b,#ff5252);animation:load 2.2s ease-in-out infinite}

    /* Responsive */
    @keyframes slideDown{from{transform:translateY(-16px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes slideDownSticky{from{transform:translateY(-100%)}to{transform:translateY(0)}}
    @keyframes load{0%{width:0%}50%{width:80%}100%{width:100%}}
    @media (max-width:768px){.container{padding:1rem}.header h1{font-size:2.2rem}}
    .with-sticky{padding-top:5.5rem}
  </style>
</head>
<body>
  <div class="bg-gradient"></div>

  <!-- Sticky email bar -->
  <div id="stickyEmailBar" class="sticky-email-bar">
    <div class="sticky-content">
      <span class="sticky-text">üìß Don‚Äôt lose your plan! Get your PDF emailed to you.</span>
      <button id="stickyEmailBtn" class="btn-sticky">Email My PDF</button>
      <button id="dismissSticky" class="btn-dismiss">√ó</button>
    </div>
  </div>

  <div class="container" id="mainContainer">
    <div class="header">
      <h1>BroSplit AI</h1>
      <p id="subtitle" class="subtitle">Your personalized workout plan is ready</p>
    </div>

    <!-- Success / action -->
    <div class="card success-card">
      <h2 class="success-title">üéâ Payment Complete</h2>
      <p id="successDesc" class="muted">You're ready to generate your personalized plan!</p>
      <div class="button-group" style="margin-top:1rem">
        <button id="generatePlan" class="btn btn-primary">üöÄ Generate My Plan</button>
        <a href="index.html" class="btn btn-secondary">‚Üê Back to Start</a>
      </div>
    </div>

    <!-- Loading area -->
    <div id="planLoading"></div>
    <div id="planError"></div>

    <!-- Workout -->
    <div id="planContainer" class="card" style="display:none">
      <h2 class="section-title">üèãÔ∏è Your Custom Workout Plan</h2>
      <p class="muted" style="margin-bottom:1rem">Tailored specifically for your goals and preferences</p>
      <div id="plan" class="white-card"></div>
    </div>

    <!-- Nutrition -->
    <div id="nutritionContainer" class="card" style="display:none">
      <h2 class="section-title">ü•ó Nutrition Plan (Macros + Meals)</h2>
      <div id="nutritionSummary" class="nutrition-grid"></div>
      <div id="nutritionGuidelines" class="code" style="display:none"></div>
      <hr class="divider" />
      <div id="nutritionDays"></div>
      <hr class="divider" />
      <h3 style="margin:.25rem 0 0.5rem">üõí Grocery List</h3>
      <div id="groceryList" class="nutrition-grid"></div>
      <h3 style="margin:1rem 0 0.5rem">üç± Batch Prep</h3>
      <div id="batchPrep" class="code"></div>

      <div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-top:1rem">
        <button id="downloadNutrition" class="btn btn-secondary">‚¨áÔ∏è Download Nutrition PDF</button>
      </div>
    </div>

    <!-- Email button -->
    <div style="text-align:center;margin:1rem 0 2rem">
      <button id="emailPlan" class="btn btn-primary" style="display:none">üìß Email Me My PDF</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const API_URL = window.location.origin;
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('session_id');

    if (!sessionId) {
      document.body.innerHTML = `
        <div class="bg-gradient"></div>
        <div class="container">
          <div class="card"><h2>‚ö†Ô∏è Error: No session ID found</h2>
          <p>Please return to the homepage and try again.</p>
          <a href="index.html" class="btn btn-primary" style="margin-top:1rem">‚Üê Back to Start</a></div>
        </div>`;
      throw new Error('No session_id in URL');
    }

    // Pull form data + tier
    let formData = {}; let planType = 'workout';
    try {
      formData = JSON.parse(localStorage.getItem('brosplitForm') || '{}');
      planType = localStorage.getItem('planType') || 'workout';
    } catch {}

    // Adjust sticky text + buttons per plan
    const stickyTextEl = document.querySelector('.sticky-text');
    const emailBtn = document.getElementById('emailPlan');
    const stickyEmailBtn = document.getElementById('stickyEmailBtn');
    if (planType === 'pro') {
      document.getElementById('subtitle').textContent = 'Your personalized training + nutrition plan is ready';
      document.getElementById('successDesc').textContent = 'We‚Äôll generate your workout plan and your macros + meals.';
      stickyTextEl.textContent = 'üìß Don‚Äôt lose your plan! Get both PDFs emailed to you.';
      emailBtn.textContent = 'üìß Email Me My PDFs';
      stickyEmailBtn.textContent = 'Email My PDFs';
    }

    // DOM refs
    const mainContainer = document.getElementById('mainContainer');
    const stickyEmailBar = document.getElementById('stickyEmailBar');
    const dismissStickyBtn = document.getElementById('dismissSticky');
    const planCard = document.getElementById('planContainer');
    const planDiv = document.getElementById('plan');
    const planLoading = document.getElementById('planLoading');
    const planError = document.getElementById('planError');
    const nutritionCard = document.getElementById('nutritionContainer');
    const nutritionSummary = document.getElementById('nutritionSummary');
    const nutritionGuidelines = document.getElementById('nutritionGuidelines');
    const nutritionDays = document.getElementById('nutritionDays');
    const groceryList = document.getElementById('groceryList');
    const batchPrep = document.getElementById('batchPrep');
    const downloadNutrition = document.getElementById('downloadNutrition');
    const generateBtn = document.getElementById('generatePlan');

    let stickyBarDismissed = false;
    let nutritionPlan = null;
    let rawWorkoutPlan = ""; // store raw text for emailing

    function showStickyBar(){
      if(!stickyBarDismissed){
        stickyEmailBar.classList.add('show');
        mainContainer.classList.add('with-sticky');
      }
    }
    function hideStickyBar(){
      stickyEmailBar.classList.remove('show');
      mainContainer.classList.remove('with-sticky');
    }
    dismissStickyBtn.addEventListener('click', ()=>{ stickyBarDismissed = true; hideStickyBar(); });

    // Email (includes both PDFs if nutrition was generated)
    async function sendEmail(button){
      const original = button.innerHTML; button.disabled = true; button.innerHTML = '‚è≥ Sending‚Ä¶';
      const email = (formData.email || '').trim();
      if(!email){
        alert("‚ö†Ô∏è No email found. Please go back and enter your email.");
        button.innerHTML = original; button.disabled = false; return;
      }
      const planText = rawWorkoutPlan || planDiv.innerText || planDiv.textContent || '';
      try{
        const resp = await fetch(`${API_URL}/api/email-plan`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, plan: planText, nutrition: nutritionPlan })
        });
        if(!resp.ok) throw new Error('Server rejected the email.');
        button.innerHTML = '‚úÖ Sent!';
        localStorage.removeItem('brosplitForm'); localStorage.removeItem('planType');
        setTimeout(()=> button.innerHTML = original, 2500);
        stickyBarDismissed = true; hideStickyBar();
      }catch(e){
        console.error(e); button.innerHTML = '‚ùå Failed'; alert("‚ö†Ô∏è " + (e.message || 'Email failed'));
        setTimeout(()=> button.innerHTML = original, 2500);
      }finally{ button.disabled = false; }
    }
    emailBtn.addEventListener('click', e => sendEmail(e.currentTarget));
    stickyEmailBtn.addEventListener('click', e => sendEmail(e.currentTarget));

    // Render Nutrition (handles both .day_plans and .days; shows ALL days)
    function renderNutrition(n){
      if(!n) return;
      const s = n.summary || {};
      nutritionSummary.innerHTML = `
        <div class="pill"><strong>Calories</strong><br>${s.calories || s.kcal} kcal</div>
        <div class="pill"><strong>Protein</strong><br>${s.protein_g} g/day${s.per_meal_protein_g ? ` (~${s.per_meal_protein_g} g/meal)` : ''}</div>
        <div class="pill"><strong>Carbs</strong><br>${s.carbs_g} g/day</div>
        <div class="pill"><strong>Fat</strong><br>${s.fat_g} g/day</div>
        <div class="pill"><strong>Fiber</strong><br>${s.fiber_target_g} g/day</div>
        <div class="pill"><strong>Sodium cap</strong><br>${s.sodium_cap_mg} mg/day</div>
        <div class="pill"><strong>Meals/day</strong><br>${s.meals_per_day}</div>
      `;

      const g = n.guidelines || {};
      const gText = [
        g.protein_per_meal_rule ? `‚Ä¢ Protein per meal: ${g.protein_per_meal_rule}` : null,
        g.pre_post ? `‚Ä¢ Pre/Post training: ${g.pre_post}` : null,
        g.notes ? `‚Ä¢ Notes: ${g.notes}` : null
      ].filter(Boolean).join('\n');
      if (gText) { nutritionGuidelines.style.display = 'block'; nutritionGuidelines.textContent = gText; }

      const days = n.day_plans || n.days || [];
      nutritionDays.innerHTML = (days || []).map((d, i) => {
        const kcal = d.total_kcal || s.calories || s.kcal || '';
        const meals = (d.meals || []).map(m => {
          const ing = (m.ingredients || []).map(i => {
            const qty = i.grams ? `${i.grams} g` : i.ml ? `${i.ml} ml` : i.count ? `${i.count} ct` : (i.qty || '');
            return `‚Ä¢ ${i.item}${qty ? ` ‚Äî ${qty}` : ''}`;
          }).join('\n');
          const macro = m.macros ? ` (${m.macros.kcal || 0} kcal ‚Ä¢ P${m.macros.protein_g || 0}/C${m.macros.carbs_g || 0}/F${m.macros.fat_g || 0})` : '';
          return `\n${m.name || 'Meal'}: ${m.recipe || ''}${macro}\n${ing}`;
        }).join('\n');
        return `
          <div class="white-card" style="margin:.75rem 0">
            <div style="font-weight:800;margin-bottom:.25rem">Day ${d.day || (i+1)} ‚Äî ${kcal} kcal</div>
            <div class="code">${meals.trim()}</div>
          </div>
        `;
      }).join('');

      const groceries = (n.grocery_list && n.grocery_list.items) || n.grocery_list || [];
      groceryList.innerHTML = (groceries || []).map(it => {
        const unit = it.kg ? `${it.kg} kg` : it.ml ? `${it.ml} ml` : it.count ? `${it.count} ct` : '';
        return `<div class="pill">${it.item || it.name}${unit ? ` ‚Äî <span style="opacity:.85">${unit}</span>` : ''}</div>`;
      }).join('');

      batchPrep.textContent = (n.batch_prep || []).map(b => `‚Ä¢ ${b.day}: ${(b.steps || []).join(' ‚Ä¢ ')}`).join('\n');

      nutritionCard.style.display = 'block';
    }

    // Download nutrition PDF
    downloadNutrition.addEventListener('click', async () => {
      if (!nutritionPlan) return alert('Generate the nutrition plan first.');
      const resp = await fetch(`${API_URL}/api/nutrition-pdf`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plan: nutritionPlan })
      });
      if (!resp.ok) return alert('Failed to build PDF.');
      const { base64 } = await resp.json();
      const blob = await (await fetch(`data:application/pdf;base64,${base64}`)).blob();
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'BroSplit-Nutrition-Plan.pdf'; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    });

    // Generate flow with full loading UX
    generateBtn.addEventListener('click', async () => {
      // capture the element reference instead of relying on event object
      generateBtn.disabled = true; planError.innerHTML = ""; hideStickyBar();
      planCard.style.display = "none"; nutritionCard.style.display = "none"; emailBtn.style.display = "none";
      planDiv.innerHTML = ""; nutritionPlan = null; rawWorkoutPlan = "";

      // Phase 1 ‚Äî Workout
      planLoading.innerHTML = `
        <div class="card loading-card">
          <div>ü§ñ Building your workout split‚Ä¶</div>
          <div class="progress"><div class="bar"></div></div>
        </div>`;

      try {
        const res = await fetch(`${API_URL}/api/generate-plan`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ sessionId, ...formData })
        });
        if (!res.ok) throw new Error("Could not generate workout plan.");
        const { plan } = await res.json();
        rawWorkoutPlan = plan;
        planDiv.innerHTML = marked.parse(plan);
        planCard.style.display = "block";
        emailBtn.style.display = "inline-flex";
        planCard.scrollIntoView({ behavior: 'smooth' });

        // Phase 2 ‚Äî Nutrition (Pro only)
        if (planType === 'pro') {
          planLoading.innerHTML = `
            <div class="card loading-card">
              <div>ü•ó Creating your nutrition plan‚Ä¶</div>
              <div class="progress"><div class="bar"></div></div>
            </div>`;

          const payload = {
            sex: formData.sex,
            age: Number(formData.age),
            height_cm: formData.height_cm,
            weight_kg: formData.weight_kg,
            activity: formData.activity || 'moderate',
            goal: formData.nutrition_goal || 'recomp',
            training_load: formData.training_load || 'moderate',
            meals_per_day: formData.meals_per_day || 4,
            cuisine_prefs: formData.cuisine_prefs || [],
            diet_prefs: formData.diet_prefs || ['none'],
            allergies: formData.allergies || [],
            budget_level: formData.budget_level || 'normal',
            email: formData.email,
            sessionId // REQUIRED for server PRO gating
          };

          const nres = await fetch(`${API_URL}/api/nutrition`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if (nres.status === 401) throw new Error('Session validation missing/expired. Open the success link from Checkout again.');
          if (nres.status === 402) throw new Error('Payment not captured. If you were charged, contact support.');
          if (nres.status === 403) throw new Error('Nutrition requires the Pro plan.');
          if (!nres.ok) throw new Error("Could not generate nutrition plan.");

          const { plan: nPlan } = await nres.json();
          nutritionPlan = nPlan;
          renderNutrition(nPlan);

          setTimeout(showStickyBar, 400);
        } else {
          // Base plan ‚Üí show sticky after workout
          setTimeout(showStickyBar, 400);
        }

        // Done
        planLoading.innerHTML = `
          <div class="card loading-card" style="background:rgba(78,205,196,.1);border-color:rgba(78,205,196,.3)">
            <div>‚úÖ All set!</div>
          </div>`;
        setTimeout(()=> { planLoading.innerHTML = ""; }, 1200);

      } catch (err) {
        console.error(err);
        planLoading.innerHTML = "";
        planError.innerHTML = `
          <div class="card">
            <h3>‚ö†Ô∏è Generation Failed</h3>
            <p>${err.message || "Could not generate plan."}</p>
            <button onclick="location.reload()" class="btn btn-primary" style="margin-top:1rem">üîÑ Try Again</button>
          </div>`;
      } finally {
        generateBtn.disabled = false; // safe even if an error occurred
      }
    });

    // Optional: suppress noisy console errors in Safari
    window.addEventListener('unhandledrejection', e => {
      if (String(e.reason || '').includes('TypeError: null is not an object')) { e.preventDefault(); }
    });
  </script>
</body>
</html>
